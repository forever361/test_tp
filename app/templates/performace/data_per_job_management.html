{% extends "base.html" %}

{% block title %}Flasky{% endblock %}

{% block js %}
<script src="/static/bootstrap-table-1.21.3/dist/bootstrap-table.min.js"></script>
<link href="/static/bootstrap-table-1.21.3/dist/bootstrap-table.min.css" rel="stylesheet"/>

<script src="/static/tanos/bootbox.all.min.js"></script>
<script src="/static/tanos/popper.js"></script>
<script src="/static/tanos/toastr.min.js"></script>
<link href="/static/tanos/toastr.min.css" rel="stylesheet"/>

<!-- Bootstrap Font Icon CSS -->
<!--<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css">-->

<!--<script src="/static/tanos/data_connect.js"></script>-->


{% endblock %}

{% block content %}

<style>
    .panel-info {
        border-color: #eee;
    }

    .panel-info > .panel-heading {
        color: #000;
        background-color: #fff;
        border-color: #eee;
    }

    .panel-info > .panel-heading + .panel-collapse > .panel-body {
        border-top-color: #000;
    }

    .panel-info > .panel-heading .badge {
        color: #d9edf7;
        background-color: #31708f;
    }

    .panel-info > .panel-footer + .panel-collapse > .panel-body {
        border-bottom-color: #000;
    }


    .table-striped > tbody > tr:nth-of-type(odd) {
        background-color: #fff;
    }

    .form-control-input.has-value {
        background-color: #eee; /* 填入内容后的背景色 */
    }


</style>


{#<div style="background-color: #ef2f27;  width: 100%; display: flex; flex-direction: column; align-items: flex-start;">#}


{#    <ul class="nav nav-tabs">#}
{#      <li class="nav-item">#}
{#        <a class="nav-link" aria-current="page" href="/api_batch_suite">API Suite Management</a>#}
{#      </li>#}
{#      <li class="nav-item">#}
{#        <a class="nav-link " href="/api_batch_case">API case Management</a>#}
{#      </li>#}
{#      <li class="nav-item">#}
{#        <a class="nav-link  active" href="/api_batch_job">Job Management</a>#}
{#      </li>#}
{##}
{#      <li class="nav-item">#}
{#        <a class="nav-link" href="/api_batch_result">Job detail</a>#}
{#      </li>#}
{##}
{#    </ul>#}

    <div style=" margin: 20px; margin-bottom: 100px " class="card">
         <div class="card-body" style="padding:10px;">
            <!-- Default panel contents -->
            <h5 class="card-title">Data Performance Job Management</h5>
            <div class="card-text">
{#                <p>On this page, you can manage the jobs.</p>#}

{#                <button class="btn btn-primary" id="btnImport" type="button" style="width: 120px; height:40px; margin-top:20px;display: flex; justify-content: center; align-items: center;" iconalignment="center">Import File</button>#}

                <table class="table table-striped"
                       id="table"
                       data-toggle="table"
{#                       data-height="600"#}
                       data-url="data_per_job_search.json"
                       data-pagination="true"
                       data-search="true"
                       data-buttons-class="primary"
                      data-buttons="buttons"
                       data-sort-name="job_id"
                       data-sort-order="desc"

                >
                    <thead>
                    <tr>
                        <th data-field="user_id" data-width="15" data-width-unit="%">USER ID
                        </th>
                        <th data-field="job_id" data-align="center" data-sortable="true" data-width="15" data-width-unit="%">JOB ID
                        </th>
                        <th data-field="job_name" data-formatter="suiteNameFormatter" data-align="left" data-sortable="true"  >JOB NAME
                        </th>
                        <th data-field="create_date" data-align="left" data-sortable="true" >CREATE DATE
                        </th>
                        <th data-formatter="actionFormatter" data-align="center" data-width="15" data-width-unit="%">OPERATION</th>

                    </tr>
                    </thead>
                </table>


            </div>
        </div>

    </div>

      <div class="offcanvas offcanvas-end" tabindex="-1" id="add-row-modal"
                     aria-labelledby="offcanvasRightLabel">
                    <div class="offcanvas-header">
                        <h5 class="offcanvas-title" id="offcanvasRightLabel">Add new job</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="offcanvas"
                                aria-label="Close"></button>
                    </div>
                    <div class="offcanvas-body">
                        <form>
                            <div class="form-group">
                                <label for="new-row-name" class="col-form-label">Name:</label>
                                <input type="text" class="form-control" id="new-row-name"
                                       placeholder="example:pg-servcer1-example">
                            </div>

                        </form>

                        <div style="margin-top:20px">
                            <div style="width:80%; margin:auto; text-align:center">
                                <button style="float:left" type="button" class="btn btn-danger"
                                        data-bs-dismiss="modal">Close
                                </button>
                                <button style="float:right" type="button" class="btn btn-success" id="save-new-row">
                                    Save
                                </button>
                            </div>

                        </div>

                    </div>
                </div>









<script>

    function buttons() {
        return {
            btnAdd: {
                text: 'Add new row',
                icon: 'fa-regular fa-plus',
                render: true,
                event: function () {
                    $('#add-row-modal').offcanvas('show');
                },
                attributes: {
                    class: 'Add a new row to the table',
                    style: 'width: 80px; height:38px; margin-left:40px;display: flex; justify-content: center; align-items: center;',
                }
            }
        }
    }

    const $table = $('#table');



    // Formatter for "action" column
    function actionFormatter(value, row, index) {
        return '<button  class="btn btn-sm btn-danger delete-row" style="margin-left: 10px;"><i class="fa-regular fa-trash-can"></i></button>'

    }

        // Formatter for "action" column
    {#function suiteFormatter(value, row, index) {#}
    {#    return '<a href="javascript:;" onclick="window.location.href=(\'/batch_search_case?id='+ row.id + '\')">suite_name</a> '#}
    {##}

    function suiteNameFormatter(value, row) {
        return '<a href="/data_per_search_case?id=' + row.job_id + '">' + value + '</a>';
    }



    /////delete function
    function deleteRow($tr) {
        const id = $tr.find('td:eq(1)').text();
        console.log({id: id})
        $.ajax({
            url: '/delete_per_job',
            type: 'POST',
            data: JSON.stringify({"id": id, "act": "del"}),
            contentType: 'application/json',
            success: function () {
                toastr.success('Delete successfully!');
                $('#table').bootstrapTable('refresh');
            },
            error: function (error) {
                console.log(error);
                toastr.error('Failed to delete the job. Please try again.');
            }
        });
    }


    $table.on('click', '.delete-row', function () {
        const $tr = $(this).closest('tr');

        let dialog = bootbox.dialog({
            title: 'Delete item!',
            message: "<p>Please confirm if you want to delete? </p>",
            centerVertical: true,
            buttons:
                {
                    cancel: {
                        label: "No",
                        className: 'btn-danger',
                        callback:
                            function () {
                                console.log('Custom cancel clicked');
                            }
                    },

                    ok: {
                        label: "Yes",
                        className: 'btn-success',
                        callback:
                            function () {
                                deleteRow($tr)
                            }
                    }
                }
        });

    });


    $('#save-new-row').click(function () {
        // Get the values of the new row from the form fields
        const job_name = $('#new-row-name').val();

        // Create a new row object with the values

        // Add the new row to the table
        // $table.bootstrapTable('append', newRow);

        // Hide the modal dialog
        $('#add-row-modal').offcanvas('hide');

        // addRow function
        $.ajax({
            url: '/add_per_job',
            type: 'POST',
            data: JSON.stringify({
                'job_name': job_name,
            }),
            contentType: 'application/json',
            success: function (data) {
                data = String(data);
                if (data.startsWith('<!DOCTYPE permission html>')) {
                    // data以<!DOCTYPE html>开头
                    $('#add-row-modal').offcanvas('hide');
                    // toastr.error('Sorry, you do not have permission to access!');
                    $('#table').bootstrapTable('refresh');
                    let dialog = bootbox.dialog({
                        title: 'Permission denied!',
                        message: "<p>Sorry, you do not have permission to operate! </p>",
                        centerVertical: true,
                        buttons:
                            {
                                ok: {
                                    label: "Yes",
                                    className: 'btn-danger',
                                    callback:
                                        function () {
                                        }
                                }
                            }
                    });


                } else {
                    console.info(data)
                    toastr.success('new job added successfully!');
                    $('#add-row-modal').offcanvas('hide');
                    $('#table').bootstrapTable('refresh');

                }
            },
            error: function () {
                $('#add-row-modal').offcanvas('hide');
                toastr.error('failed to add new job!');
                $('#table').bootstrapTable('refresh');

            }
        });

    });


</script>




{% if message %}

{% endif %}

{% endblock %}