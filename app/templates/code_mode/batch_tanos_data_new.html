{% extends "base.html" %}

{% block title %}Flasky{% endblock %}

{% block js %}
<script src="/static/bootstrap-table-1.21.3/dist/bootstrap-table.min.js"
        xmlns:searchHighlightFormatter="http://www.w3.org/1999/xhtml"></script>
<link href="/static/bootstrap-table-1.21.3/dist/bootstrap-table.min.css" rel="stylesheet"/>

<script src="/static/tanos/bootbox.all.min.js"></script>
<script src="/static/tanos/popper.js"></script>
<script src="/static/tanos/toastr.min.js"></script>
<link href="/static/tanos/toastr.min.css" rel="stylesheet"/>

<!-- Bootstrap Font Icon CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">

<!--<script src="/static/tanos/data_connect.js"></script>-->


{% endblock %}

<style>
    .pagination {
        display: none !important;
    }

</style>


{% block content %}


<div style="background-color: #eee; display: flex; flex-direction: column;">

    <div style="display: flex; justify-content: space-between; align-items: center; margin: 20px">
        <button id="save-case" type="button" class="btn btn-primary" style="width: 200px">Save Case</button>
        <div style="display: flex; justify-content: center; align-items: center; width: 600px">
            <input type="text" class="form-control"   aria-describedby="basic-addon1"
                   id="casename">
        </div>
        <button id="add-new-row" type="button" class="btn btn-primary"><i class="bi bi-plus"></i></button>
    </div>


    <div class="row" style="justify-content: center;">
        <form class="card  mb-3" method="POST">


            <div class="row g-0">
                <div class="col-md-11">

                    <div class="card-body " style="text-align: center;">
                        <div class="card-title ">
                            <div style="display:flex; width:100%; justify-content: start; align-items: center; padding-left:68px; padding-top:10px">
                                <div style="width:13.8%; display:flex; align-items:center; ">
                                    <p>Job name</p>
                                </div>
                                <input style="width:80.5%; " type="text" class="form-control"
                                       aria-describedby="basic-addon1" id="new-row-name_1" >
                            </div>
                        </div>
                        <div class="card-text" style="text-align: left;">

                            <div class="container text-center ">
                                <div class="row">
                                    <div class="col-md-6">

                                        <div class="row">
                                            <label class="col-md-12 control-label">Source</label>
                                            <div class="col-md-3" style="padding-top: 10px;">
                                                <b style="color:red">*</b> Data point
                                            </div>

                                            <div class="col-md-9" style="padding-top: 10px;">
                                                <select id="source_point_select_top_s_1" class="form-select ">

                                                </select>
                                            </div>

                                            <p class="col-md-3 control-label" style="padding-top: 10px;">Condition</p>
                                            <div class="col-md-9" style="padding-top: 10px;">
                                                <input type="text" class="form-control"
                                                       placeholder="source where condition"
                                                       aria-describedby="basic-addon1" id="new-s-condition-name_1">
                                            </div>
                                        </div>
                                    </div>

                                    <div class="col-md-6">
                                        <div class="row">

                                            <label class="col-md-12 control-label">Target</label>
                                            <div class="col-md-3" style="padding-top: 10px;">
                                                <b style="color:red">*</b> Data point
                                            </div>

                                            <div class="col-md-9" style="padding-top: 10px;">
                                                <select class="form-select" id="source_point_select_top_t_1"
                                                        name="source_point_select_top_t" data-live-search="true">

                                                </select>
                                            </div>

                                            <p class="col-md-3 control-label" style="padding-top: 10px;">Condition</p>
                                            <div class="col-md-9" style="padding-top: 10px;">
                                                <input type="text" class="form-control"
                                                       placeholder="target where condition"
                                                       aria-describedby="basic-addon1" id="new-t-condition-name_1">
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-12">
                                        <hr style="filter: alpha(opacity=100,finishopacity=0,style=3)" width="100%"
                                            color="#6f5499" size="3">
                                        <label class="col-md-12" style="padding-bottom:5px">Rules</label>
                                    </div>

                                    <div style="display:flex; width:100%; justify-content: start; align-items: center; padding-left:0px">
                                        <p style="width:13.8% ">Select rules</p>
                                        <select class="form-select" name="select_rule_top" id="select_rule_top_1"
                                                style="width:85.5%">
                                            <option selected>Default</option>
                                            <option>Check-table-header</option>
                                            <option>Check-count</option>
                                            <option>Check-the-first-200-rows</option>
                                            <option>Check-the-first-500-rows</option>
                                            <option>Check-the-first-1000-rows</option>
                                        </select>
                                    </div>


                                    <div style="display:flex; width:100%; justify-content: start; align-items: center; padding-left:0px; padding-top:10px">
                                        <div style="width:13.8%; display:flex; align-items:center; padding-left:40px">
                                            <p>Custom rules</p>
                                        </div>
                                        <input style="width:85.5%; " type="text" class="form-control"
                                               aria-describedby="basic-addon1"
                                               id="new-customrules-name_1">
                                    </div>


                                    <div style="display:flex; width:100%; justify-content: start; align-items: center; padding-left:0px; padding-top:10px">
                                        <div style="width:13.8%; display:flex; align-items:center; padding-left:30px">
                                            <span style="color:red; ">*&nbsp</span> <span>By fields </span></div>
                                        <input style="width:85.5%; " type="text" class=" form-control "
                                               placeholder="the columns used as the checking basis"
                                               aria-describedby="basic-addon1" id="new-field-name_1">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-1">
                    <div style="display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100%;">
                        <button type="button" class="btn btn-primary card-edit" style="width: 100px;margin-top: 15px"
                                id="card-edit"> Save
                        </button>
                        <button type="button" class="btn btn-danger card-delete" style="width: 100px;margin-top: 15px"
                                id="card-delete"> Delete
                        </button>
                        <button type="button" class="btn btn-success card-run" style="width: 100px;margin-top: 15px"
                                id="card-run"> Run
                        </button>
                        <button type="submit" class="btn btn-warning report"
                                style="width: 100px;margin-top: 15px;display:none;" id="Report"> Report
                        </button>
                    </div>
                    <div class="card-id" style="display: none">${item.job_id}</div>
                </div>

            </div>
        </form>

    </div>


</div>

<!--下拉窗口-->
<div class="offcanvas offcanvas-top" tabindex="-1" id="add-row-top-canvas"
     aria-labelledby="offcanvasRightLabel" style="height: 600px">
    <div class="offcanvas-header">
        <h5 class="offcanvas-title" id="offcanvasTopLabel">Add new connection</h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas"
                aria-label="Close"></button>
    </div>
    <div class="offcanvas-body">
        <form class="card  mb-3" method="POST">

            <div class="card-body " style="text-align: center;">
                <div class="card-title ">
                    <div style="display:flex; width:100%; justify-content: start; align-items: center; padding-left:68px; padding-top:10px">
                        <div style="width:13.8%; display:flex; align-items:center; ">
                            <p>Job name</p>
                        </div>
                        <input style="width:80.5%; " type="text" class="form-control"
                               aria-describedby="basic-addon1" id="new-row-name">
                    </div>
                </div>
                <div class="card-text" style="text-align: left;">

                    <div class="container text-center ">
                        <div class="row">
                            <div class="col-md-6">

                                <div class="row">
                                    <label class="col-md-12 control-label">Source</label>
                                    <div class="col-md-3" style="padding-top: 10px;">
                                        <b style="color:red">*</b> Data point
                                    </div>

                                    <div class="col-md-9" style="padding-top: 10px;">
                                        <select id="source_point_select_top_s" class="form-select ">

                                        </select>
                                    </div>

                                    <p class="col-md-3 control-label" style="padding-top: 10px;">Condition</p>
                                    <div class="col-md-9" style="padding-top: 10px;">
                                        <input type="text" class="form-control" placeholder="source where condition"
                                               aria-describedby="basic-addon1" id="new-s-condition-name">
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="row">

                                    <label class="col-md-12 control-label">Target</label>
                                    <div class="col-md-3" style="padding-top: 10px;">
                                        <b style="color:red">*</b> Data point
                                    </div>

                                    <div class="col-md-9" style="padding-top: 10px;">
                                        <select class="form-select" id="source_point_select_top_t"
                                                name="source_point_select_top_t" data-live-search="true">
                                            ${optionsHtml_source}
                                        </select>
                                    </div>

                                    <p class="col-md-3 control-label" style="padding-top: 10px;">Condition</p>
                                    <div class="col-md-9" style="padding-top: 10px;">
                                        <input type="text" class="form-control" placeholder="target where condition"
                                               aria-describedby="basic-addon1" id="new-t-condition-name">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-12">
                                <hr style="filter: alpha(opacity=100,finishopacity=0,style=3)" width="100%"
                                    color="#6f5499" size="3">
                                <label class="col-md-12" style="padding-bottom:5px">Rules</label>
                            </div>

                            <div style="display:flex; width:100%; justify-content: start; align-items: center; padding-left:0px">
                                <p style="width:13.8% ">Select rules</p>
                                <select class="form-select" name="select_rule_top" id="select_rule_top"
                                        style="width:85.5%">
                                    <option selected>Default</option>
                                    <option>Check-table-header</option>
                                    <option>Check-count</option>
                                    <option>Check-the-first-200-rows</option>
                                    <option>Check-the-first-500-rows</option>
                                    <option>Check-the-first-1000-rows</option>
                                </select>
                            </div>


                            <div style="display:flex; width:100%; justify-content: start; align-items: center; padding-left:0px; padding-top:10px">
                                <div style="width:13.8%; display:flex; align-items:center; padding-left:40px">
                                    <p>Custom rules</p>
                                </div>
                                <input style="width:85.5%; " type="text" class="form-control"
                                       aria-describedby="basic-addon1"
                                       id="new-customrules-name">
                            </div>


                            <div style="display:flex; width:100%; justify-content: start; align-items: center; padding-left:0px; padding-top:10px">
                                <div style="width:13.8%; display:flex; align-items:center; padding-left:30px">
                                    <span style="color:red; ">*&nbsp</span> <span>By fields </span></div>
                                <input style="width:85.5%; " type="text" class=" form-control "
                                       placeholder="the columns used as the checking basis"
                                       aria-describedby="basic-addon1" id="new-field-name">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </form>

        <div style="margin-top:20px">
            <div style="width:80%; margin:auto; text-align:center">
                <button style="float:left" type="button" class="btn btn-danger"
                        data-bs-dismiss="offcanvas">Close
                </button>
                <button style="float:right" type="button" class="btn btn-success" id="save-new-row">
                    Save
                </button>
            </div>

        </div>

    </div>
</div>

<script>

    var date = new Date();
    var year = date.getFullYear();
    var month = date.getMonth()+ 1;
    var day = date.getDate();
    var hour = date.getHours();
    var minute = date.getMinutes();
    var second = date.getSeconds();
    var now_time = year + '-' + month + '-' +day + '-' + hour;

    var casename_example = now_time + '_example';
    var jobname= now_time + '_job_example';
    var casename_value = document.getElementById("casename")
<!--    casename_placeholder.setAttribute("placeholder",casename_example)-->

    casename_value.value = casename_example

    var jobname_value = document.getElementById("new-row-name_1")
    jobname_value.value = jobname





    ////Add row function
    $('#add-new-row').click(function () {
        $('#add-row-top-canvas').offcanvas('show');


        $.ajax({
            url: "/getMyPoint",
            type: "GET",
            success: function (data) {
                var options = "";
                for (let i = 0; i < data.length; i++) {
                    const option = data[i];
                    options += `<option value="${option.value}" >${option.text}</option>`;
                }
                console.info(options)
                $('#source_point_select_top_s').empty().append(options)
                $('#source_point_select_top_t').empty().append(options)
            }
        })

    })

    $('#save-new-row').click(function () {
        // Get the values of the new row from the form fields
        const job_name = $('#new-row-name').val();
        const source_point = $('#source_point_select_top_s').val();
        const target_point = $('#source_point_select_top_t').val();
        const source_condition = $('#new-s-condition-name').val();
        const target_condition = $('#new-t-condition-name').val();
        const select_rules = $('#select_rule_top').val();
        const custom_rules = $('#new-customrules-name').val();
        const fields = $('#new-field-name').val();


        // Hide the modal dialog
        $('#add-row-top-canvas').offcanvas('hide');

        // addRow function
        $.ajax({
            url: '/add_job',
            type: 'POST',
            data: JSON.stringify({
                'job_name': job_name,
                'job': {
                    "source_point": source_point,
                    "target_point": target_point,
                    "source_condition": source_condition,
                    "target_condition": target_condition,
                    "select_rules": select_rules,
                    "custom_rules": custom_rules,
                    "fields": fields,
                }

            }),
            contentType: 'application/json',
            success: function () {
                $('#add-row-top-canvas').modal('hide');
                location.reload()
                toastr.success('new row added successfully!');
            },
            error: function () {
                toastr.error('failed to add new row!');
                $('#add-row-top-canvas').modal('hide');
            }
        });

    });


</script>

<script>
    document.getElementById("save-case").addEventListener("click", function () {
        var case_name = document.getElementById("casename").value;
        var job_name = document.getElementById("new-row-name_1").value;
        var source_point = document.getElementById("source_point_select_top_s_1").value;
        var source_condition = document.getElementById("new-s-condition-name_1").value;
        var target_point = document.getElementById("source_point_select_top_t_1").value;
        var target_condition = document.getElementById("new-t-condition-name_1").value;
        var select_rules = document.getElementById("select_rule_top_1").value;
        var custom_rules = document.getElementById("new-customrules-name_1").value;
        var fields = document.getElementById("new-field-name_1").value;

        var params = {
            'case_name': case_name,
            'job_name': job_name,
            'job': {
                "source_point": source_point,
                "target_point": target_point,
                "source_condition": source_condition,
                "target_condition": target_condition,
                "select_rules": select_rules,
                "custom_rules": custom_rules,
                "fields": fields,
            }
        };


        $.ajax({
            type: "POST",
            url: "/saveCase",
            data: JSON.stringify(params),
            contentType: "application/json",
            success: function (response) {
                // 跳转到：http://127.0.0.1:8889/data_edit_test_case_tanos?id=10074
                case_id = response.case_id;
                var domain = '{{ domain }}'; 
                window.location.href = `https://${domain}/data_edit_test_case_tanos?id=${case_id}`;
                toastr.success('save test case successfully!');

            },
            error: function (xhr, status, error) {
                toastr.error('Fail to save test case!');
                console.log("Request failed: " + error);
            }
        });
    });


    $.ajax({
        url: "/getMyPoint",
        type: "GET",
        success: function (data) {
            var options = "";
            for (let i = 0; i < data.length; i++) {
                const option = data[i];
                options += `<option value="${option.value}" >${option.text}</option>`;
            }
            console.info(options)
            $('#source_point_select_top_s_1').empty().append(options)
            $('#source_point_select_top_t_1').empty().append(options)
        }
    })

</script>


{% if message %}

{% endif %}

{% endblock %}