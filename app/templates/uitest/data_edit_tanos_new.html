{% extends "base.html" %}

{% block title %}Flasky{% endblock %}

{% block js %}
<script src="/static/bootstrap-table-1.21.3/dist/bootstrap-table.min.js"
        xmlns:searchHighlightFormatter="http://www.w3.org/1999/xhtml"></script>
<link href="/static/bootstrap-table-1.21.3/dist/bootstrap-table.min.css" rel="stylesheet"/>

<script src="/static/tanos/bootbox.all.min.js"></script>
<script src="/static/tanos/popper.js"></script>
<script src="/static/tanos/toastr.min.js"></script>
<link href="/static/tanos/toastr.min.css" rel="stylesheet"/>

<!-- Bootstrap Font Icon CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">

<!--<script src="/static/tanos/data_connect.js"></script>-->


{% endblock %}

<style>
    .pagination {
        display: none !important;
    }
</style>


{% block content %}


<div style="background-color: #eee;  ">
    <div class="row" id="card-group" style="justify-content: center; display:flex; padding-top: 15px;">
    </div>
    <nav>
        <ul class="pagination justify-content-center"></ul>
    </nav>
</div>

<script>


    $(document).ready(function () {
        const pageSize = 3;
        let currentPage = 1;
        let totalPages = 0;
        let cardsData = [];


        $.ajax({
            url: "/getMyPoint",
            type: "GET",
            success: function (data) {
                var options = "";
                options = data;
                $.ajax({
                    url: "/job_search.json",
                    type: "GET",
                    dataType: "json",
                    success: function (data) {
                        cardsData = data.map(item => {

                            var optionsHtml_source = "";
                            for (let i = 0; i < options.length; i++) {
                                const option = options[i];
                                const selected = (option.value === item.job.source_point) ? "selected" : "";
                                optionsHtml_source += `<option value="${option.value}" ${selected}>${option.text}</option>`;
                            }


                            var optionsHtml_target = "";
                            for (let i = 0; i < options.length; i++) {
                                const option = options[i];
                                const selected = (option.value === item.job.target_point) ? "selected" : "";
                                optionsHtml_target += `<option value="${option.value}" ${selected}>${option.text}</option>`;
                            }

                            const selectRule = item.job.select_rules || "Default";

                            return `
                                    <div class="col-md-12"  ">
                                          <form class="card  mb-3" method="POST">

                                                <div class="card-body " style="text-align: center;" >
                                                    <h5 class='card-title'> ${item.job_name} </h5>
                                                    <div class="card-text" style="text-align: left;">

                                                        <div class="container text-center ">
                                                            <div class="row">
                                                                <div class="col-md-6">

                                                                    <div class="row">
                                                                        <label class="col-md-12 control-label">Source</label>
                                                                        <div class="col-md-3" style="padding-top: 10px;">
                                                                            <b style="color:red">*</b> Data point
                                                                        </div>

                                                                        <div class="col-md-9" style="padding-top: 10px;">
                                                                            <select id="source_point_select" class="form-select " >
                                                                                ${optionsHtml_source}
                                                                            </select>
                                                                        </div>

                                                                        <p class="col-md-3 control-label" style="padding-top: 10px;">Condition</p>
                                                                        <div class="col-md-9" style="padding-top: 10px;">
                                                                            <input type="text" class="form-control" placeholder="source where condition"
                                                                            aria-describedby="basic-addon1" value=${item.job.source_condition}>
                                                                        </div>
                                                                    </div>
                                                                </div>

                                                                <div class="col-md-6">
                                                                    <div class="row">

                                                                        <label class="col-md-12 control-label">Target</label>
                                                                        <div class="col-md-3" style="padding-top: 10px;">
                                                                            <b style="color:red">*</b> Data point
                                                                        </div>

                                                                        <div class="col-md-9" style="padding-top: 10px;">
                                                                            <select class="form-select" name="select_t" data-live-search="true">
                                                                                ${optionsHtml_target}
                                                                            </select>
                                                                        </div>

                                                                        <p class="col-md-3 control-label" style="padding-top: 10px;">Condition</p>
                                                                        <div class="col-md-9" style="padding-top: 10px;">
                                                                            <input type="text" class="form-control" placeholder="target where condition"
                                                                            aria-describedby="basic-addon1" value=${item.job.target_condition}>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>

                                                            <div class="row">
                                                                <div class="col-md-12">
                                                                    <hr style="filter: alpha(opacity=100,finishopacity=0,style=3)" width="100%" color="#6f5499" size="3">
                                                                    <label class="col-md-12" style="padding-bottom:5px">Rules</label>
                                                                </div>

                                                                <div style="display:flex; width:100%; justify-content: start; align-items: center; padding-left:0px">
                                                                    <p style="width:13.8% ">Select rules</p>
                                                                    <select class="form-select" name="select_rule" id="select_rule" style="width:85.5%">
                                                                        <option ${selectRule === "Default" ? "selected" : ""}>Default</option>
                                                                        <option ${selectRule === "Check-table-header" ? "selected" : ""}>Check-table-header</option>
                                                                        <option ${selectRule === "Check-count" ? "selected" : ""}>Check-count</option>
                                                                        <option ${selectRule === "Check-the-first-200-rows" ? "selected" : ""}>Check-the-first-200-rows</option>
                                                                        <option ${selectRule === "Check-the-first-500-rows" ? "selected" : ""}>Check-the-first-500-rows</option>
                                                                        <option ${selectRule === "Check-the-first-1000-rows" ? "selected" : ""}>Check-the-first-1000-rows</option>
                                                                        </select>
                                                                </div>


                                                                <div style="display:flex; width:100%; justify-content: start; align-items: center; padding-left:0px; padding-top:10px">
                                                                    <div style="width:13.8%; display:flex; align-items:center; padding-left:40px">
                                                                        <p>Custom rules</p>
                                                                    </div>
                                                                    <input style="width:85.5%; " type="text" class="form-control"
                                                                    placeholder="undefined" aria-describedby="basic-addon1" value=${item.job.custom_rules}>
                                                                </div>


                                                                <div style="display:flex; width:100%; justify-content: start; align-items: center; padding-left:0px; padding-top:10px">
                                                                    <div style="width:13.8%; display:flex; align-items:center; padding-left:30px">
                                                                        <span style="color:red; ">*&nbsp</span> <span>By fields </span></div>
                                                                        <input name="field" style="width:85.5%; " type="text" class=" form-control "
                                                                             placeholder="the columns used as the checking basis" aria-describedby="basic-addon1" value=${item.job.fields}>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                               </div>
                                          </form>
                                    </div>
                `

                        });
                        totalPages = Math.ceil(cardsData.length / pageSize);
                        renderPage(currentPage);
                        renderPagination();

                    },
                    error: function (error) {
                        console.log(error);
                    }
                });

            },
            error: function (error) {
                console.log(error);
            }

        })


        function renderPage(page) {
            const start = (page - 1) * pageSize;
            const end = start + pageSize;
            const pageData = cardsData.slice(start, end);
            const html = pageData.join('');
            $("#card-group").html(`<div class="row">${html}</div>`);
        }

        function renderPagination() {
            const html = `
                  <li class="page-item ${currentPage === 1 ? "disabled" : ""}">
                    <a class="page-link" href="#" onclick="changePage(${currentPage - 1})">Previous</a>
                  </li>
                  ${Array.from({length: totalPages}, (_, i) => `
                    <li class="page-item ${i + 1 === currentPage ? "active" : ""}">
                      <a class="page-link" href="#" onclick="changePage(${i + 1})">${i + 1}</a>
                    </li>
                  `).join('')}
                  <li class="page-item ${currentPage === totalPages ? "disabled" : ""}">
                    <a class="page-link" href="#" onclick="changePage(${currentPage + 1})">Next</a>
                  </li>
                `;
            $(".pagination").html(html);
        }

        window.changePage = function (page) {
            if (page < 1 || page > totalPages) return;
            currentPage = page;
            renderPage(currentPage);
            renderPagination();
        }
    });


</script>


{% if message %}

{% endif %}

{% endblock %}
