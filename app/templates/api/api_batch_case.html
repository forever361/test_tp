{% extends "base.html" %}

{% block title %}Flasky{% endblock %}

{% block js %}
<script src="/static/bootstrap-table-1.21.3/dist/bootstrap-table.min.js"></script>
<link href="/static/bootstrap-table-1.21.3/dist/bootstrap-table.min.css" rel="stylesheet"/>

<script src="/static/tanos/bootbox.all.min.js"></script>
<script src="/static/tanos/popper.js"></script>
<script src="/static/tanos/toastr.min.js"></script>
<link href="/static/tanos/toastr.min.css" rel="stylesheet"/>

<!-- Bootstrap Font Icon CSS -->
<!--<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css">-->

<!--<script src="/static/tanos/data_connect.js"></script>-->


{% endblock %}

{% block content %}

<style>
    .panel-info {
        border-color: #eee;
    }

    .panel-info > .panel-heading {
        color: #000;
        background-color: #fff;
        border-color: #eee;
    }

    .panel-info > .panel-heading + .panel-collapse > .panel-body {
        border-top-color: #000;
    }

    .panel-info > .panel-heading .badge {
        color: #d9edf7;
        background-color: #31708f;
    }

    .panel-info > .panel-footer + .panel-collapse > .panel-body {
        border-bottom-color: #000;
    }


    .table-striped > tbody > tr:nth-of-type(odd) {
        background-color: #fff;
    }

    .form-control-input.has-value {
        background-color: #eee; /* 填入内容后的背景色 */
    }


</style>

<style>
    .custom-table td {
        max-width: 150px; /* 设置单元格的最大宽度 */
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap; /* 不换行 */
    }

    /* 如果需要，悬停时显示完整内容 */
    .custom-table td:hover {
        overflow: visible;
        white-space: normal; /* 允许换行 */
        z-index: 1;
        position: relative;
        background-color: white;
    }
</style>

{#<div style="background-color: #ef2f27;  width: 100%; display: flex; flex-direction: column; align-items: flex-start;">#}


    <ul class="nav nav-tabs">
      <li class="nav-item">
        <a class="nav-link " aria-current="page" href="/api_batch_suite">API Suite Management</a>
      </li>
      <li class="nav-item">
        <a class="nav-link active" href="/api_batch_case">API case Management</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="/api_batch_job">Job Management</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="/api_batch_result">Job detail</a>
      </li>
    </ul>

    <div style=" margin: 20px; margin-bottom: 100px " class="card">
         <div class="card-body" style="padding:10px;">
            <!-- Default panel contents -->
            <h5 class="card-title">API Case Management</h5>
            <div class="card-text">
                <p>On this page, you can manage API test cases and generate job.</p>

                <button class="btn btn-primary" type="button" id="btnGenjob" style="width: 120px; height:40px; margin-top:20px;display: flex; justify-content: center; align-items: center;" iconalignment="center">Generate job </button>

                <table class="table table-striped custom-table"
                       id="table"
                       data-toggle="table"
                       data-url="/batch_search_case_json?id={{ suite_id }}"
                       data-pagination="true"
                       data-search="true"
                       data-buttons-class="primary"
                       data-sort-name="case_id"
{#                       data-sort-order="desc"#}
                       data-page-list="[10, 25, 50, 100, all]"
{#                        data-multiple-select-row="true"#}
{#                        data-click-to-select="true"#}

                >
                    <thead>
                    <tr >
                        <th data-field="state" data-checkbox="true"></th>
{#                        <th data-field="state" data-checkbox="true"></th>#}
                        <th data-field="user_id"  data-width="5" data-width-unit="%">USER ID
                        </th>

                         <th data-field="suite_id" data-align="center" data-sortable="true" data-width="5" data-width-unit="%">SUITE ID
                        </th>
                        <th data-field="case_id" data-align="center" data-sortable="true" data-width="5" data-width-unit="%">CASE ID
                        </th>

                        <th data-field="url" data-align="left" data-sortable="true" >URL
                        </th>
                        <th data-field="methods" data-align="left" data-sortable="true" >Method
                        </th>
                        <th data-field="request_body" data-align="left" data-sortable="true" >Request_body
                        </th>
                        <th data-field="headers" data-align="left" data-sortable="true" >Headers
                        </th>
                        <th data-field="expected_result" data-align="left" data-sortable="true" >Expected_result
                        </th>
                        <th data-formatter="actionFormatter" data-align="center" data-width="15" data-width-unit="%">OPERATION</th>

                    </tr>
                    </thead>
                </table>


            </div>
        </div>

    </div>





<script>

    $(document).ready(function () {
        // 监听按钮点击事件
        $('#btnGenjob').on('click', function () {
            var rows = $('#table').bootstrapTable('getSelections');
            if (rows.length < 1) {
                alert("请至少选择一条数据");
            } else {
                // 多选时获取case_id
                var caseIds = [];
                for (var i = 0; i < rows.length; i++) {
                    caseIds.push(rows[i].case_id);
                }

                // caseIds 数组中存储了选中行的 case_id
                {#alert(caseIds);#}
                $.ajax({
                    url: '/gen_api_batch_job',
                    type: 'POST',
                    data: JSON.stringify({caseIds: caseIds}),
                    contentType: 'application/json',
                    success: function (data) {
                        job_id = data.job_id
                        window.location.href = '/batch_search_result?id=' + job_id;
                        {#toastr.success('generate job successfully!');#}

                    },
                    error: function (error) {

                        toastr.error('failed to generate job.');
                    }
                });


            }

        });
    });


</script>


<script>

    const $table = $('#table');


    // Formatter for "action" column
    function actionFormatter(value, row, index) {
        return '<button  class="btn btn-sm btn-danger delete-row" style="margin-left: 10px;"><i class="fa-regular fa-trash-can"></i></button>'

    }

    {#function actionFormatter(value, row, index) {#}
    {#    return '<button class="btn btn-sm btn-primary edit-row" onclick="window.location.href=(\'/data_edit_test_case_tanos?id=' + row.id + '\')"><i class="fa-regular fa-pen-to-square"></i></button> ' +#}
    {#        '<button  class="btn btn-sm btn-danger delete-row" style="margin-left: 10px;"><i class="fa-regular fa-trash-can"></i></button>' +#}
    {#        '<button class="btn btn-sm btn-success report-row" style="margin-left: 10px;" onclick="window.location.href=(\'/data_search_report?id=' + row.id + '\')"><i class="fa-sharp fa-regular fa-eye"></i></button> '#}
    {##}
    {#}#}


    /////delete function
    function deleteRow($tr) {
        const id = $tr.find('td:eq(1)').text();
        console.log({id: id})
        $.ajax({
            url: '/delete_api_batch_suite',
            type: 'POST',
            data: JSON.stringify({"id": id, "act": "del"}),
            contentType: 'application/json',
            success: function () {
                toastr.success('delete successfully!');
                $('#table').bootstrapTable('refresh');
            },
            error: function (error) {
                console.log(error);
                toastr.error('failed to delete the suite. Please try again.');
            }
        });
    }


    $table.on('click', '.delete-row', function () {
        const $tr = $(this).closest('tr');

        let dialog = bootbox.dialog({
            title: 'Delete item!',
            message: "<p>Please confirm if you want to delete? </p>",
            centerVertical: true,
            buttons:
                {
                    cancel: {
                        label: "No",
                        className: 'btn-danger',
                        callback:
                            function () {
                                console.log('Custom cancel clicked');
                            }
                    },

                    ok: {
                        label: "Yes",
                        className: 'btn-success',
                        callback:
                            function () {
                                deleteRow($tr)
                            }
                    }
                }
        });

    });


</script>




{% if message %}

{% endif %}

{% endblock %}